name: CI for Todo List Frontend

on:
  push:
    branches: ["main"]
    paths:
      - "apps/todo-list/frontend/**"

jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. Node.js 설정
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: ./apps/todo-list/frontend/package-lock.json

      # 3. 의존성 설치
      - name: Install dependencies
        run: npm ci
        working-directory: ./apps/todo-list/frontend

      # 4. 프론트엔드 빌드
      - name: Build frontend
        run: npm run build
        working-directory: ./apps/todo-list/frontend
        env:
          VITE_API_URL: http://192.168.80.200/api

      # 5. Docker Hub에 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6. 7자리 SHA를 환경변수로 저장
      - name: Export short SHA
        id: vars
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      # 7. Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/todo-list/frontend
          file: ./apps/todo-list/frontend/Dockerfile.prod
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/k8s-labs-todo-frontend:${{ steps.vars.outputs.SHORT_SHA }}

      # 8. 생성된 이미지 태그 출력
      - name: Print image tag
        run: echo "Image tagged with ${{ secrets.DOCKERHUB_USERNAME }}/k8s-labs-todo-frontend:${{ steps.vars.outputs.SHORT_SHA }}"
      
      # 9. 매니페스트 저장소 체크아웃  
      - name: Checkout manifests repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTION_PAT }}
          repository: ${{ github.repository_owner }}/k8s-labs-todo-list-manifests
          path: manifests
          fetch-depth: 1

      # 10. yq 설치 (직접 다운로드 후 환경변수 설정)
      - name: Install yq
        run: |
          set -e
          YQ_DIR="$HOME/.local/bin"
          mkdir -p "$YQ_DIR"
          curl -sL -o "$YQ_DIR/yq" https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x "$YQ_DIR/yq"
          echo "YQ_BIN=$YQ_DIR/yq" >> $GITHUB_ENV
          "$YQ_DIR/yq" --version
      
      # 11. Helm 배포 지시서의 이미지 태그 업데이트
      - name: Update image tag in ArgoCD Application manifest
        run: |
          NEW_TAG=${GITHUB_SHA:0:7}
          echo "Updating frontend image tag to: $NEW_TAG"

          if [ ! -f manifests/todo-list-application.yaml ]; then
            echo "Error: Manifest file not found"
            exit 1
          fi

          # frontend.image.tag 파라미터 업데이트
          "$YQ_BIN" e "(.spec.source.helm.parameters[] | select(.name == \"frontend.image.tag\") | .value) = \"$NEW_TAG\"" -i manifests/todo-list-application.yaml

          echo "Updated manifest:"
          "$YQ_BIN" e '.spec.source.helm.parameters[] | select(.name == "frontend.image.tag")' manifests/todo-list-application.yaml
          
      # 12. 변경 사항 커밋 및 푸시
      - name: Commit and push changes
        run: |
          cd manifests
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ci(frontend): Update image tag to ${GITHUB_SHA:0:7}"
            git push
          fi
